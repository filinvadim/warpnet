#!/bin/bash

echo "Pre-push hook started..."

FILE="version"

if [ ! -f "$FILE" ]; then
    echo "Version file not found!"
    exit 1
fi

CURRENT_VERSION=$(cat $FILE)

# Проверяем, что пушится
while read local_ref local_sha remote_ref remote_sha; do
    # Если пушится существующий тег, выходим из хука
    if [[ "$remote_ref" == "refs/tags/v$CURRENT_VERSION" ]]; then
        echo "Tag v$CURRENT_VERSION is already being pushed. Skipping hook."
        exit 0
    fi
done

# Проверяем, существует ли тег с текущей версией локально
if git rev-parse "v$CURRENT_VERSION" >/dev/null 2>&1; then
    echo "Tag v$CURRENT_VERSION already exists locally. Skipping creation."
else
    # Создаём новый тег
    git tag -a "v$CURRENT_VERSION" -m "Release version $CURRENT_VERSION"
    echo "Tag v$CURRENT_VERSION created."
fi

# Пушим тег
git push origin "v$CURRENT_VERSION"

echo "Tag v$CURRENT_VERSION pushed successfully."
