<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter Clone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #15202b;
            color: #fff;
            display: flex;
        }
        #navigation {
            width: 200px;
            padding: 20px;
            background-color: #192734;
            display: none;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
        #navigation.active {
            display: flex;
        }
        #navigation a {
            text-decoration: none;
            color: #fff;
            font-size: 18px;
            padding: 10px 0;
            margin-bottom: 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        #navigation a:hover {
            background-color: #1da1f2;
        }
        #main-content {
            display: flex;
            width: 100%;
            margin-left: 220px;
            padding: 20px;
        }
        #container {
            width: 60%;
            background-color: #192734;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        #recommended,
        #settings-container {
            width: 30%;
            margin-left: 20px;
            padding: 20px;
            background-color: #192734;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }
        #recommended.active,
        #settings-container.active {
            display: block;
        }
        h1,
        h3 {
            text-align: center;
            color: #fff;
        }
        #login.active,
        #timeline-container.active,
        #profile-container.active {
            display: block;
        }
        #login,
        #timeline-container,
        #profile-container {
            display: none;
        }
        #login input,
        #new-tweet textarea,
        #settings-container input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #657786;
            background-color: #192734;
            color: #fff;
        }
        #login button,
        #new-tweet button,
        #settings-container button {
            background-color: #1da1f2;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        #login button:hover,
        #new-tweet button:hover,
        #settings-container button:hover {
            background-color: #0d95e8;
        }
        .tweet {
            border-bottom: 1px solid #657786;
            padding: 10px 0;
        }
        .tweet:last-child {
            border-bottom: none;
        }
        .tweet-text {
            font-size: 16px;
            color: #fff;
        }
        .tweet-user,
        .tweet-time {
            color: #8899a6;
            font-size: 14px;
        }
        .recommended-user {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .recommended-user img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .recommended-user-info {
            display: flex;
            align-items: center;
        }
        .follow-button {
            background-color: #1da1f2;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .follow-button:hover {
            background-color: #0d95e8;
        }
        #profile-header {
            display: flex;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #657786;
        }
        #profile-header img {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }
        #profile-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        #profile-buttons button {
            background-color: #1da1f2;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100px;
        }
        #profile-buttons button:hover {
            background-color: #0d95e8;
        }
    </style>
</head>
<body>
<div id="navigation">
    <a href="#" onclick="navigateHome()">Home</a>
    <a href="#">Notifications</a>
    <a href="#">Messages</a>
    <a href="#" onclick="navigateProfile()">Profile</a>
    <a href="#" onclick="navigateSettings()">Settings</a>
</div>
<div id="main-content">
    <div id="container">
        <div id="login" class="active">
            <h1>Login</h1>
            <div id="login-form">
                <input id="username" type="text" placeholder="Enter your username">
                <input id="password" type="password" placeholder="Enter your password">
                <button onclick="login()">Login</button>
            </div>
        </div>
        <div id="timeline-container">
            <div id="new-tweet">
                <textarea id="tweet-text" rows="3" placeholder="What's happening?"></textarea>
                <button onclick="postTweet()">Tweet</button>
            </div>
            <div id="timeline"></div>
        </div>
        <div id="profile-container">
            <div id="profile-header">
                <img id="profile-pic" src="https://via.placeholder.com/80" alt="Profile Picture">
                <div>
                    <h2 id="profile-username">@username</h2>
                    <p id="profile-id"></p>
                    <p id="profile-description">This is a short bio about the user.</p>
                </div>
            </div>
            <div id="profile-buttons">
                <button onclick="loadFollowers()">Followers</button>
                <button onclick="loadFollowing()">Following</button>
            </div>
            <div id="profile-tweets"></div>
        </div>
    </div>
    <div id="recommended">
        <h3>Who to follow</h3>
        <div id="recommended-users"></div>
    </div>
    <div id="settings-container">
        <h3>Settings</h3>
        <div>
            <h4>Change Username</h4>
            <input id="new-username" type="text" placeholder="Enter new username">
            <button onclick="changeUsername()">Change</button>
        </div>
        <div>
            <h4>Node Hosts</h4>
            <ul id="host-list"></ul>
            <input id="new-hosts" type="text" placeholder="Add new hosts, separated by commas">
            <button onclick="addHosts()">Add Hosts</button>
        </div>
    </div>
</div>
<script>
    const apiUrl = 'http://localhost:6969';
    let currentUserId = null, currentUsername = null, currentSessionToken = null;

    async function login() {
        if (currentSessionToken !== null) {
            document.getElementById('login').classList.remove('active');
        }
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`${apiUrl}/v1/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();

            if (data.user?.user_id && data.token) {
                sessionStorage.setItem('userId', data.user.user_id);
                sessionStorage.setItem('username', data.user.username);
                sessionStorage.setItem('X-SESSION-TOKEN', data.token);
                currentUserId = data.user.user_id;
                currentUsername = data.user.username;
                currentSessionToken = data.token;

                document.getElementById('login').classList.remove('active');
                document.getElementById('navigation').classList.add('active');
                navigateHome();
            } else {
                console.log('Login failed');
            }
        } catch (error) {
            console.error('Error during login:', error);
        }
    }

    function addHeaders(headers) {
        headers["X-SESSION-TOKEN"] = sessionStorage.getItem('X-SESSION-TOKEN');
        return headers;
    }

    function navigateHome() {
        if (currentSessionToken !== null) {
            document.getElementById('login').classList.remove('active');
        }
        document.getElementById('timeline-container').classList.add('active');
        document.getElementById('profile-container').classList.remove('active');
        document.getElementById('settings-container').classList.remove('active');
        document.getElementById('recommended').classList.add('active');
        loadTimeline();
        loadRecommendedUsers();
    }

    function navigateSettings() {
        document.getElementById('profile-container').classList.remove('active');
        document.getElementById('settings-container').classList.add('active');
        document.getElementById('recommended').classList.remove('active');
        loadHostList();
    }

    function navigateProfile() {
        document.getElementById('timeline-container').classList.remove('active');
        document.getElementById('profile-container').classList.add('active');
        document.getElementById('settings-container').classList.remove('active');
        document.getElementById('recommended').classList.remove('active');
        loadProfile();
    }

    let usersCursor = null;
    const usersLimit = 3;  // Лимит твитов за одну загрузку

    async function loadRecommendedUsers() {
        try {
            let url =`${apiUrl}/v1/api/users?limit=${usersLimit}`
            if (usersCursor) {
                url += `&cursor=${usersCursor}`;
            }
            const response = await fetch(url, { headers: addHeaders({}) });

            const data = await response.json();

            const recommendedDiv = document.getElementById('recommended-users');
            if (!usersCursor) {
                recommendedDiv.innerHTML = '';
            }

            data.users.forEach(user => {
                if (user?.user_id === currentUserId) {
                    return;
                }
                recommendedDiv.innerHTML += `
                    <div class="recommended-user">
                        <div class="recommended-user-info">
                            <img src="https://via.placeholder.com/40" alt="User">
                            <div>@${user.username}</div>
                        </div>
                        <button class="follow-button" onclick="followUser('${user.user_id}')">Follow</button>
                    </div>`;
            });

            document.getElementById('recommended').classList.add('active');

            usersCursor = data.cursor || null;
            const loadMoreButton = document.getElementById('load-more');
            if (usersCursor) {
                if (!loadMoreButton) {
                    const button = document.createElement('button');
                    button.id = 'load-more';
                    button.textContent = 'Load More';
                    button.style.marginTop = '10px';
                    button.onclick = () => loadRecommendedUsers(); // Передаем функцию с правильным контекстом
                    recommendedDiv.appendChild(button);
                }
            } else if (loadMoreButton) {
                loadMoreButton.remove();
            }
        } catch (error) {
            console.error('Error loading recommended users:', error);
        }
    }

    let timelineCursor = null; // Переменная для хранения курсора
    const timelineLimit = 20;  // Лимит твитов за одну загрузку

    async function loadTimeline() {
        try {
            // Формируем URL с параметрами курсора и лимита
            let url = `${apiUrl}/v1/api/tweets/timeline/${currentUserId}?limit=${timelineLimit}`;
            if (timelineCursor) {
                url += `&cursor=${timelineCursor}`;
            }

            const response = await fetch(url, { headers: addHeaders({}) });

            // Проверяем успешность ответа
            if (!response.ok) {
                console.error('Failed to fetch timeline:', response.statusText);
                return;
            }

            const data = await response.json();

            const timelineDiv = document.getElementById('timeline');

            // Если курсор отсутствует, это первая загрузка — очищаем ленту
            if (!timelineCursor) {
                timelineDiv.innerHTML = '';
            }

            // Проверяем наличие твитов
            if (!data.tweets || data.tweets.length === 0) {
                console.warn('No tweets found');
                return;
            }

            // Добавляем твиты в ленту
            data.tweets.forEach(tweet => {
                const tweetTime = new Date(tweet.created_at).toLocaleString();
                timelineDiv.innerHTML += `
                <div class="tweet">
                    <div class="tweet-text">${tweet.content}</div>
                    <div class="tweet-user">@${tweet.username}</div>
                    <div class="tweet-time">${tweetTime}</div>
                </div>`;
            });

            timelineCursor = data.cursor || null;

            // Если есть еще данные для загрузки, добавляем кнопку "Загрузить еще"
            const loadMoreButton = document.getElementById('load-more');
            if (timelineCursor) {
                if (!loadMoreButton) {
                    const button = document.createElement('button');
                    button.id = 'load-more';
                    button.textContent = 'Load More';
                    button.style.marginTop = '10px';
                    button.onclick = () => loadTimeline(); // Передаем функцию с правильным контекстом
                    timelineDiv.appendChild(button);
                }
            } else if (loadMoreButton) {
                loadMoreButton.remove();
            }
        } catch (error) {
            console.error('Error loading timeline:', error);
        }
    }

    let tweetsCursor = null; // Переменная для хранения курсора
    const tweetsLimit = 20;  // Лимит твитов за одну загрузку

    async function loadProfile() {
        try {
            let url = `${apiUrl}/v1/api/tweets/${currentUserId}?limit=${tweetsLimit}`
            if (tweetsCursor) {
                url += `&cursor=${tweetsCursor}`;
            }
            const response = await fetch(url, { headers: addHeaders({}) });
            const data = await response.json();

            const profileUsername = sessionStorage.getItem('username');
            const profileId = sessionStorage.getItem('userId');

            document.getElementById('profile-username').innerText = '@' + profileUsername;
            document.getElementById('profile-id').innerText = 'User ID: ' + profileId;

            const profileTweetsDiv = document.getElementById('profile-tweets');

            if (!tweetsCursor) {
                profileTweetsDiv.innerHTML = '<h3>Your Tweets</h3>';
            }
            data.tweets.forEach(tweet => {
                const tweetTime = new Date(tweet.created_at).toLocaleString();
                profileTweetsDiv.innerHTML += `
                    <div class="tweet">
                        <div class="tweet-text">${tweet.content}</div>
                        <div class="tweet-time">${tweetTime}</div>
                    </div>`;
            });

            tweetsCursor = data.cursor || null;
            // Если есть еще данные для загрузки, добавляем кнопку "Загрузить еще"
            const loadMoreButton = document.getElementById('load-more');
            if (tweetsCursor) {
                if (!loadMoreButton) {
                    const button = document.createElement('button');
                    button.id = 'load-more';
                    button.textContent = 'Load More';
                    button.style.marginTop = '10px';
                    button.onclick = () => loadProfile(); // Передаем функцию с правильным контекстом
                    profileTweetsDiv.appendChild(button);
                }
            } else if (loadMoreButton) {
                loadMoreButton.remove();
            }
        } catch (error) {
            console.error('Error loading profile:', error);
        }
    }

    async function postTweet() {
        const tweetText = document.getElementById('tweet-text').value;
        if (!tweetText) {
            console.log('Tweet cannot be empty');
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/v1/api/tweets`, {
                method: 'POST',
                headers: addHeaders({ 'Content-Type': 'application/json' }),
                body: JSON.stringify({ content: tweetText, user_id: currentUserId, username: currentUsername })
            });

            if (response.ok) {
                document.getElementById('tweet-text').value = '';
                await loadTimeline();
            } else {
                console.log('Failed to post tweet');
            }
        } catch (error) {
            console.error('Error posting tweet:', error);
        }
    }

    async function loadHostList() {
        try {
            const response = await fetch(`${apiUrl}/v1/api/nodes/settings?name=node_addresses`, { headers: addHeaders({}) });
            const data = await response.json();

            const hostList = document.getElementById('host-list');
            hostList.innerHTML = '';
            data.hosts.forEach(host => {
                hostList.innerHTML += `<li>${host}</li>`;
            });
        } catch (error) {
            console.error('Error loading hosts:', error);
        }
    }

    async function addHosts() {
        const newHosts = document.getElementById('new-hosts').value;
        if (!newHosts) return console.log('Please enter hosts');

        try {
            const response = await fetch(`${apiUrl}/v1/api/nodes/settings`, {
                method: 'POST',
                headers: addHeaders({ 'Content-Type': 'application/json' }),
                body: JSON.stringify({ name: 'node_addresses',value: newHosts.split(',') })
            });

            if (response.ok) {
                await loadHostList();
                document.getElementById('new-hosts').value = '';
            } else {
                console.log('Failed to add hosts');
            }
        } catch (error) {
            console.error('Error adding hosts:', error);
        }
    }

    async function changeUsername() {
        const newUsername = document.getElementById('new-username').value;
        if (!newUsername) return console.log('Please enter a new username');

        try {
            const response = await fetch(`${apiUrl}/v1/api/auth/change-username`, {
                method: 'POST',
                headers: addHeaders({ 'Content-Type': 'application/json' }),
                body: JSON.stringify({ user_id: currentUserId, username: newUsername })
            });

            if (response.ok) {
                sessionStorage.setItem('username', newUsername);
                currentUsername = newUsername;
                console.log('Username changed successfully');
            } else {
                console.log('Failed to change username');
            }
        } catch (error) {
            console.error('Error changing username:', error);
        }
    }

    async function followUser(userId) {
        try {
            const response = await fetch(`${apiUrl}/v1/api/users/follow`, {
                method: 'POST',
                headers: addHeaders({ 'Content-Type': 'application/json' }),
                body: JSON.stringify({ readerId: currentUserId, writerId: userId })
            });

            if (response.ok) {
                await loadRecommendedUsers();
            } else {
                console.log('Failed to follow user');
            }
        } catch (error) {
            console.error('Error following user:', error);
        }
    }

    window.onload = async () => {
        const userId = sessionStorage.getItem('userId');
        if (userId) await navigateHome();
    };
</script>
</body>
</html>
