<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter Clone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #15202b;
            color: #ffffff;
        }

        #container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            background-color: #192734;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        h1 {
            text-align: center;
            color: #ffffff;
        }

        #login, #timeline-container {
            display: none;
        }

        #login.active, #timeline-container.active {
            display: block;
        }

        #login input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #657786;
            background-color: #192734;
            color: #ffffff;
        }

        #login button {
            background-color: #1da1f2;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        #login button:hover {
            background-color: #0d95e8;
        }

        .tweet {
            border-bottom: 1px solid #657786;
            padding: 10px 0;
        }

        .tweet:last-child {
            border-bottom: none;
        }

        .tweet-text {
            font-size: 16px;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .tweet-user {
            color: #8899a6;
            font-size: 14px;
        }

        .tweet-time {
            color: #8899a6;
            font-size: 12px;
        }

        #new-tweet {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #657786;
        }

        #new-tweet textarea {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #657786;
            margin-bottom: 10px;
            resize: none;
            background-color: #192734;
            color: #ffffff;
        }

        #new-tweet button {
            background-color: #1da1f2;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        #new-tweet button:hover {
            background-color: #0d95e8;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="login" class="active">
        <h1>Login</h1>
        <div id="login-form">
            <input id="username" type="text" placeholder="Enter your username">
            <input id="password" type="password" placeholder="Enter your password (up to 32 bytes)">
            <button onclick="login()">Login</button>
        </div>
    </div>

    <div id="timeline-container">
        <div id="new-tweet">
            <textarea id="tweet-text" rows="3" placeholder="What's happening?"></textarea>
            <button onclick="postTweet()">Tweet</button>
        </div>

        <div id="timeline"></div>
    </div>
</div>

<script>
    const apiUrl = 'http://localhost:6969'; // Укажите ваш API-эндпоинт
    let currentUserId = null;
    let currentUsername = null;

    function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (username === '' || password === '') {
            alert('Username and password cannot be empty');
            return;
        }

        // Проверка, что пароль не длиннее 32 байт
        if (password.length > 32) {
            alert('Password must be a maximum of 32 bytes');
            return;
        }

        const loginData = {
            username: username,
            password: password
        };

        fetch(`${apiUrl}/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(loginData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.user_id) {
                    // Сохраняем user_id в sessionStorage
                    sessionStorage.setItem('userId', data.user_id);
                    sessionStorage.setItem('username', data.username);
                    currentUserId = data.user_id;
                    showTimeline();
                } else {
                    alert('Login failed');
                }
            })
            .catch(error => console.error('Error during login:', error));
    }

    function showTimeline() {
        document.getElementById('login').classList.remove('active');
        document.getElementById('timeline-container').classList.add('active');
        loadTimeline();
    }

    function loadTimeline() {
        currentUsername = sessionStorage.getItem('username'); // Получаем user_id из sessionStorage
        currentUserId = sessionStorage.getItem('userId'); // Получаем user_id из sessionStorage
        if (!currentUserId) {
            alert('User not logged in');
            return;
        }

        fetch(`${apiUrl}/tweets/timeline/${currentUserId}`)
            .then(response => response.json())
            .then(data => {
                const timelineDiv = document.getElementById('timeline');
                timelineDiv.innerHTML = '';
                data.tweets.forEach(tweet => {
                    const tweetDiv = document.createElement('div');
                    tweetDiv.classList.add('tweet');
                    const tweetTime = new Date(tweet.created_at).toLocaleString();
                    tweetDiv.innerHTML = `
                        <div class="tweet-text">${tweet.content}</div>
                        <div class="tweet-user">@${tweet.username}</div>
                        <div class="tweet-time">${tweetTime}</div>
                    `;
                    timelineDiv.appendChild(tweetDiv);
                });
            })
            .catch(error => console.error('Error loading timeline:', error));
    }

    function postTweet() {
        currentUsername = sessionStorage.getItem('username'); // Получаем user_id из sessionStorage

        const tweetText = document.getElementById('tweet-text').value;
        if (tweetText === '') {
            alert('Tweet cannot be empty');
            return;
        }

        const newTweet = {
            content: tweetText,
            user_id: currentUserId,
            username: currentUsername
        };

        fetch(`${apiUrl}/tweets`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newTweet)
        })
            .then(response => {
                if (response.ok) {
                    document.getElementById('tweet-text').value = '';
                    loadTimeline(); // Перезагрузим ленту после добавления твита
                } else {
                    alert('Failed to post tweet');
                }
            })
            .catch(error => console.error('Error posting tweet:', error));
    }

    // Отправка команды при закрытии вкладки
    window.addEventListener('beforeunload', function (e) {
        sendCloseServiceCommand();
    });

    function sendCloseServiceCommand() {
        fetch(`${apiUrl}/auth/logout`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: currentUserId
            })
        }).catch(error => {
            console.error('Error closing service:', error);
        });
    }

    window.onload = function() {
        // Проверяем, есть ли уже user_id в sessionStorage
        currentUserId = sessionStorage.getItem('userId');
        if (currentUserId) {
            showTimeline();
        }
    }
</script>
</body>
</html>
