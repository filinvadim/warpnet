<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter Clone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: #15202b; color: #fff; display: flex;
        }
        #navigation {
            width: 200px; padding: 20px;
            background-color: #192734; display: none;
            flex-direction: column; height: 100vh;
            position: fixed; top: 0; left: 0;
        }
        #navigation.active { display: flex; }
        #navigation a {
            text-decoration: none; color: #fff;
            font-size: 18px; padding: 10px 0;
            margin-bottom: 10px; border-radius: 5px;
            transition: background-color 0.2s;
        }
        #navigation a:hover { background-color: #1da1f2; }
        #container {
            width: 100%; max-width: 600px; margin: 20px auto;
            background-color: #192734; padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-radius: 10px;
            margin-left: 220px;
        }
        h1 { text-align: center; color: #fff; }
        #login.active, #timeline-container.active, #profile-container.active { display: block; }
        #login, #timeline-container, #profile-container { display: none; }
        #login input, #new-tweet textarea {
            width: 100%; padding: 10px; font-size: 16px;
            margin-bottom: 10px; border-radius: 5px;
            border: 1px solid #657786; background-color: #192734; color: #fff;
        }
        #login button, #new-tweet button {
            background-color: #1da1f2; color: #fff;
            border: none; padding: 10px; border-radius: 5px; cursor: pointer;
        }
        #login button:hover, #new-tweet button:hover { background-color: #0d95e8; }
        .tweet { border-bottom: 1px solid #657786; padding: 10px 0; }
        .tweet:last-child { border-bottom: none; }
        .tweet-text { font-size: 16px; color: #fff; }
        .tweet-user, .tweet-time { color: #8899a6; font-size: 14px; }
        /* Profile Styles */
        #profile-header { display: flex; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #657786; }
        #profile-header img { border-radius: 50%; width: 80px; height: 80px; margin-right: 20px; }
        #profile-buttons { display: flex; justify-content: space-around; margin-top: 10px; }
        #profile-buttons button { background-color: #1da1f2; color: #fff; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100px; }
        #profile-buttons button:hover { background-color: #0d95e8; }
    </style>
</head>
<body>
<div id="navigation">
    <a href="#" onclick="navigateHome()">Home</a>
    <a href="#">Notifications</a>
    <a href="#">Messages</a>
    <a href="#" onclick="navigateProfile()">Profile</a>
    <a href="#">Settings</a>
</div>
<div id="container">
    <div id="login" class="active">
        <h1>Login</h1>
        <div id="login-form">
            <input id="username" type="text" placeholder="Enter your username">
            <input id="password" type="password" placeholder="Enter your password (up to 32 bytes)">
            <button onclick="login()">Login</button>
        </div>
    </div>
    <div id="timeline-container">
        <div id="new-tweet">
            <textarea id="tweet-text" rows="3" placeholder="What's happening?"></textarea>
            <button onclick="postTweet()">Tweet</button>
        </div>
        <div id="timeline"></div>
    </div>
    <div id="profile-container">
        <div id="profile-header">
            <img id="profile-pic" src="https://via.placeholder.com/80" alt="Profile Picture">
            <div>
                <h2 id="profile-username">@username</h2>
                <p id="profile-id"></p>
                <p id="profile-description">This is a short bio about the user.</p>
            </div>
        </div>
        <div id="profile-buttons">
            <button onclick="loadFollowers()">Followers</button>
            <button onclick="loadFollowing()">Following</button>
        </div>
        <div id="profile-tweets"></div>
    </div>
</div>
<script>
    const apiUrl = 'http://localhost:6969';
    let currentUserId = null, currentUsername = null;

    function login() {
        const username = document.getElementById('username').value, password = document.getElementById('password').value;
        if (username === '' || password === '' || password.length > 32) return alert('Invalid credentials');
        fetch(`${apiUrl}/v1/api/auth/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password })
        })
            .then(res => res.json())
            .then(data => {
                if (data.user_id) {
                    sessionStorage.setItem('userId', data.user_id);
                    sessionStorage.setItem('username', data.username);
                    currentUserId = data.user_id;
                    showTimeline();
                } else alert('Login failed');
            }).catch(console.error);
    }

    function showTimeline() {
        document.getElementById('login').classList.remove('active');
        document.getElementById('timeline-container').classList.add('active');
        document.getElementById('profile-container').classList.remove('active');
        document.getElementById('navigation').classList.add('active');
        loadTimeline();
    }

    function loadTimeline() {
        currentUsername = sessionStorage.getItem('username');
        currentUserId = sessionStorage.getItem('userId');
        if (!currentUserId) return alert('User not logged in');
        fetch(`${apiUrl}/v1/api/tweets/timeline/${currentUserId}`)
            .then(res => res.json())
            .then(data => {
                const timelineDiv = document.getElementById('timeline');
                timelineDiv.innerHTML = '';
                data.tweets.forEach(tweet => {
                    const tweetTime = new Date(tweet.created_at).toLocaleString();
                    timelineDiv.innerHTML += `<div class="tweet"><div class="tweet-text">${tweet.content}</div><div class="tweet-user">@${tweet.username}</div><div class="tweet-time">${tweetTime}</div></div>`;
                });
            }).catch(console.error);
    }

    function postTweet() {
        const tweetText = document.getElementById('tweet-text').value;
        if (tweetText === '') return alert('Tweet cannot be empty');
        fetch(`${apiUrl}/v1/api/tweets`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: tweetText, user_id: currentUserId, username: currentUsername })
        })
            .then(res => { if (res.ok) document.getElementById('tweet-text').value = '', loadTimeline(); else alert('Failed to post tweet'); })
            .catch(console.error);
    }

    function navigateHome() { showTimeline(); }

    function navigateProfile() {
        document.getElementById('login').classList.remove('active');
        document.getElementById('timeline-container').classList.remove('active');
        document.getElementById('profile-container').classList.add('active');
        loadProfile();
    }

    function loadProfile() {
        const userId = sessionStorage.getItem('userId');
        const username = sessionStorage.getItem('username');
        document.getElementById('profile-username').innerText = '@' + username;
        document.getElementById('profile-id').innerText = 'User ID: ' + userId;

        fetch(`${apiUrl}/v1/api/tweets/${userId}`)
            .then(response => response.json())
            .then(data => {
                const profileTweetsDiv = document.getElementById('profile-tweets');
                profileTweetsDiv.innerHTML = '<h3>Your Tweets</h3>';
                data.tweets.forEach(tweet => {
                    // Преобразование строки даты в объект Date
                    const tweetDate = new Date(tweet.created_at);

                    // Проверяем, является ли дата валидной
                    const formattedDate = !isNaN(tweetDate.getTime()) ? tweetDate.toLocaleString() : 'Invalid Date';

                    profileTweetsDiv.innerHTML += `
                    <div class="tweet">
                        <div class="tweet-text">${tweet.content}</div>
                        <div class="tweet-time">${formattedDate}</div>
                    </div>`;
                });
            })
            .catch(error => {
                console.error('Error fetching profile tweets:', error);
            });
    }

    function loadFollowers() { alert('Load followers list'); }
    function loadFollowing() { alert('Load following list'); }

    window.addEventListener('beforeunload', () => {
        fetch(`${apiUrl}/v1/api/auth/logout`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: sessionStorage.getItem('userId') })
        }).catch(console.error);
    });

    window.onload = function () {
        if (sessionStorage.getItem('userId')) showTimeline();
    }
</script>
</body>
</html>
