/* License generated by licensor(https://github.com/Marvin9/licensor).

 Warpnet - Decentralized Social Network
 Copyright (C) 2025 Vadim Filin, https://github.com/filinvadim,
 <github.com.mecdy@passmail.net>
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 
 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
 
 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/

package obj

import (
	"reflect"

	. "github.com/polydawn/refmt/tok"
)

/*
	A MarshalMachine that unwraps an `interface{}` value,
	selects the correct machinery for handling its content,
	and delegates immediately to that machine.
*/
type marshalMachineWildcard struct {
	delegate MarshalMachine
}

func (mach *marshalMachineWildcard) Reset(slab *marshalSlab, rv reflect.Value, rt reflect.Type) error {
	// If the interface contains nil, go no further; we'll simply yield that single token.
	if rv.IsNil() {
		mach.delegate = nil
		return nil
	}
	// Pick, reset, and retain a delegate machine for the interior type.
	unwrap_rv := rv.Elem() // unwrap iface
	unwrap_rt := unwrap_rv.Type()
	mach.delegate = slab.requisitionMachine(unwrap_rt)
	return mach.delegate.Reset(slab, unwrap_rv, unwrap_rt)
}

func (mach marshalMachineWildcard) Step(driver *Marshaller, slab *marshalSlab, tok *Token) (done bool, err error) {
	if mach.delegate == nil {
		tok.Type = TNull
		return true, nil
	}
	return mach.delegate.Step(driver, slab, tok)
}
