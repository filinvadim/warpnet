/* License generated by licensor(https://github.com/Marvin9/licensor).

 Warpnet - Decentralized Social Network
 Copyright (C) 2025 Vadim Filin, https://github.com/filinvadim,
 <github.com.mecdy@passmail.net>
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 
 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
 
 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/

package obj

import (
	"reflect"

	"github.com/polydawn/refmt/obj/atlas"
	. "github.com/polydawn/refmt/tok"
)

type unmarshalMachineTransform struct {
	trFunc   atlas.UnmarshalTransformFunc
	recv_rt  reflect.Type
	delegate UnmarshalMachine // machine for handling the recv type, stepped to completion before transform applied.

	target_rv reflect.Value // given on Reset, retained until last step, and set into after using trFunc
	recv_rv   reflect.Value // if set, handle to slot where slice is stored; content must be placed into target at end.
}

func (mach *unmarshalMachineTransform) Reset(slab *unmarshalSlab, rv reflect.Value, _ reflect.Type) error {
	mach.target_rv = rv
	mach.recv_rv = reflect.New(mach.recv_rt).Elem() // REVIEW: this behavior with ptr vs not for in_rt.  the star-star case is prob not what want.
	return mach.delegate.Reset(slab, mach.recv_rv, mach.recv_rt)
}

func (mach *unmarshalMachineTransform) Step(driver *Unmarshaller, slab *unmarshalSlab, tok *Token) (done bool, err error) {
	done, err = mach.delegate.Step(driver, slab, tok)
	if err != nil {
		return
	}
	if !done {
		return
	}
	// on the last step, use transform, and finally set in real target.
	tr_rv, err := mach.trFunc(mach.recv_rv)
	// do attempt the set even if error.  user may appreciate partial progress.
	mach.target_rv.Set(tr_rv)
	return true, err
}
