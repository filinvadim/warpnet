package main

import (
	"fmt"
	"log"
	"os"
	"strings"

	"gopkg.in/yaml.v3"
)

const (
	genFilePath  = "gen/event-gen/paths.gen.go"
	yamlFilePath = "spec/event-api.yml"
	packageName  = "event"
)

type OpenAPI struct {
	Info struct {
		Version string `yaml:"version"`
	} `yaml:"info"`
	Paths map[string]interface{} `yaml:"paths"`
}

func pathToConst(path string) string {
	result := ""

	for _, c := range path {
		if c == '/' {
			result += "_"
		} else if c == '{' || c == '}' {
			continue
		} else {
			result += string(c)
		}
	}
	if result == "_" { // index
		result = "index"
	}
	result = strings.ToTitle(strings.TrimPrefix(result, "_"))
	result = strings.ReplaceAll(result, ".", "_")
	result = strings.ReplaceAll(result, "*", "")
	result = strings.ReplaceAll(result, "_VERSION", "")
	return result
}

func main() {
	data, err := os.ReadFile(yamlFilePath)
	if err != nil {
		log.Fatalln(err)
	}

	var api OpenAPI
	err = yaml.Unmarshal(data, &api)
	if err != nil {
		log.Fatalln(err)
	}
	os.Remove(genFilePath)

	split := strings.Split(api.Info.Version, ".")
	onlyMajorVersion := split[0] + ".0.0"

	disclaimer := fmt.Sprintf("// Package %s provides primitives to interact with the openapi HTTP API.\n//\n// Code generated by github.com/filinvadim/warpnet/tools/routes-gen.go DO NOT EDIT.", packageName)
	out := fmt.Sprintf("%s\npackage %s\n\nconst (\n", disclaimer, packageName)
	for path := range api.Paths {
		constName := pathToConst(path)
		path = strings.ReplaceAll(path, "{version}", onlyMajorVersion)
		out += fmt.Sprintf("    %s = \"%s\"\n", constName, path)
	}
	out += ")\n"
	err = os.WriteFile(genFilePath, []byte(out), 0644)
	if err != nil {
		log.Fatalln(err)
	}
}
